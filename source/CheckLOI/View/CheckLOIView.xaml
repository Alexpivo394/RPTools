<ui:FluentWindow
    xmlns:ui="http://lookupengine.com/xaml"
    x:Class="CheckLOI.View.CheckLOIView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:viewModel="clr-namespace:CheckLOI.ViewModels"
    xmlns:converters="clr-namespace:CheckLOI.View.Converters"
    mc:Ignorable="d"
    WindowStartupLocation="CenterScreen"
    Title="CheckLOI"
    Height="750"
    Width="1100"
    MinHeight="600"
    MinWidth="900"
    ExtendsContentIntoTitleBar="True">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Панель заголовка -->
        <ui:TitleBar Title="Инструмент экспорта LOI" Grid.Row="0">
            <ui:TitleBar.Icon>
                <ui:SymbolIcon Symbol="Box24"/>
            </ui:TitleBar.Icon>
            <ui:TitleBar.Header>
                <StackPanel Orientation="Horizontal">
                    <ui:Button 
                        Icon="{ui:SymbolIcon Symbol=Add24}" 
                        ToolTip="Добавить новую конфигурацию экспорта"
                        Command="{Binding AddTabCommand}"
                        Appearance="Secondary"
                        Margin="5,0"/>
                    <ui:Button 
                        Icon="{ui:SymbolIcon Symbol=Save24}" 
                        ToolTip="Экспорт настроек"
                        Command="{Binding ExportSettingsCommand}"
                        Appearance="Secondary"
                        Margin="5,0"/>
                    <ui:Button 
                        Icon="{ui:SymbolIcon Symbol=FolderOpen24}" 
                        ToolTip="Импорт настроек"
                        Command="{Binding ImportSettingsCommand}"
                        Appearance="Secondary"
                        Margin="5,0"/>
                </StackPanel>
            </ui:TitleBar.Header>
        </ui:TitleBar>

        <!-- Вкладки конфигураций экспорта -->
        <TabControl 
            Grid.Row="1" 
            Margin="10,5"
            ItemsSource="{Binding ExportConfigurations}"
            SelectedIndex="0"
            TabStripPlacement="Top"
            HorizontalContentAlignment="Stretch">

            <TabControl.ItemTemplate>
                <DataTemplate>
                    <Grid>
                        <Grid.ContextMenu>
                            <ContextMenu>
                                <MenuItem 
                                    Header="Переименовать" 
                                    Command="{Binding EditTabNameCommand}"
                                    Icon="{ui:SymbolIcon Symbol=Rename24}"/>
                                <MenuItem 
                                    Header="Удалить" 
                                    Command="{Binding DataContext.RemoveTabCommand, RelativeSource={RelativeSource AncestorType=TabControl}}"
                                    CommandParameter="{Binding}"
                                    Icon="{ui:SymbolIcon Symbol=Delete24}"/>
                            </ContextMenu>
                        </Grid.ContextMenu>
                        <TextBlock
                            Text="{Binding TabName}" 
                            VerticalAlignment="Center"
                            HorizontalAlignment="Center"
                            Visibility="{Binding IsTabNameEditing, Converter={converters:InverseBoolVisibilityConverter}}"/>
                        <TextBox 
                            Text="{Binding TabName}" 
                            VerticalAlignment="Center"
                            HorizontalAlignment="Center"
                            Visibility="{Binding IsTabNameEditing, Converter={converters:BoolVisibilityConverter}}"
                            MinWidth="100"
                            MaxLength="50"
                            ContextMenu="{x:Null}"/>
                    </Grid>
                </DataTemplate>
            </TabControl.ItemTemplate>

            <TabControl.ContentTemplate>
                <DataTemplate>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Параметры и категории -->
                        <Grid Grid.Row="0" Margin="0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Секция параметров -->
                            <Border Grid.Column="0" CornerRadius="5" Padding="10" Background="{DynamicResource ControlFillColorDefaultBrush}">
                                <StackPanel>
                                    <TextBlock Text="Параметры для экспорта" FontWeight="Bold" Margin="0,0,0,10"/>
                                    <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="300">
                                        <ItemsControl ItemsSource="{Binding Parameters}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <ui:TextBox 
                                                        Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                        PlaceholderText="Введите имя параметра"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                    <ui:Button 
                                        Content="Добавить параметр" 
                                        Command="{Binding AddParameterCommand}"
                                        Appearance="Secondary"
                                        Margin="0,10,0,0"
                                        HorizontalAlignment="Left"/>
                                </StackPanel>
                            </Border>

                            <!-- Секция категорий -->
                            <Border Grid.Column="2" CornerRadius="5" Padding="10" Background="{DynamicResource ControlFillColorDefaultBrush}">
                                <StackPanel>
                                    <TextBlock Text="Включаемые категории" FontWeight="Bold" Margin="0,0,0,10"/>
                                    <ui:TextBox 
                                        Text="{Binding CategoryFilter, UpdateSourceTrigger=PropertyChanged}"
                                        PlaceholderText="Фильтр категорий..."
                                        Margin="0,0,0,10"/>
                                    <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="300">
                                        <ItemsControl ItemsSource="{Binding FilteredCategories}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <CheckBox 
                                                        Content="{Binding Name}"
                                                        IsChecked="{Binding IsSelected}"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </StackPanel>
                            </Border>
                        </Grid>

                        <!-- Список моделей -->
                        <Border Grid.Row="1" CornerRadius="5" Padding="10" Margin="0,10,0,0" Background="{DynamicResource ControlFillColorDefaultBrush}">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <ui:ListView 
                                    ItemsSource="{Binding ModelsToExport}"
                                    ScrollViewer.VerticalScrollBarVisibility="Auto"
                                    MaxHeight="200">
                                    <ui:ListView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Margin="0,5">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="200"/>
                                                    <ColumnDefinition Width="200"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <ui:TextBox 
                                                    Grid.Column="0" 
                                                    Text="{Binding ModelPath}"
                                                    PlaceholderText="Путь к модели Revit"/>

                                                <ui:TextBox 
                                                    Grid.Column="1" 
                                                    Text="{Binding ViewName}"
                                                    PlaceholderText="Имя вида"
                                                    Margin="10,0,0,0"/>

                                                <ui:TextBox 
                                                    Grid.Column="2" 
                                                    Text="{Binding WorksetKeyword}"
                                                    PlaceholderText="Ключевое слово рабочего набора"
                                                    Margin="10,0,0,0"/>

                                                <ui:Button 
                                                    Grid.Column="3" 
                                                    Icon="{ui:SymbolIcon Symbol=Delete24}"
                                                    Command="{Binding DataContext.RemoveModelCommand, RelativeSource={RelativeSource AncestorType=ui:ListView}}"
                                                    CommandParameter="{Binding}"
                                                    Appearance="Transparent"
                                                    Margin="10,0,0,0"/>
                                            </Grid>
                                        </DataTemplate>
                                    </ui:ListView.ItemTemplate>
                                </ui:ListView>

                                <ui:Button 
                                    Grid.Row="1"
                                    Content="Добавить модель" 
                                    Icon="{ui:SymbolIcon Symbol=Add24}"
                                    Command="{Binding AddModelCommand}"
                                    Appearance="Secondary"
                                    Margin="0,10,0,0"
                                    HorizontalAlignment="Left"/>
                            </Grid>
                        </Border>

                        <!-- Опции экспорта -->
                        <Border Grid.Row="2" CornerRadius="5" Padding="10" Margin="0,10,0,0" Background="{DynamicResource ControlFillColorDefaultBrush}">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <TextBlock Text="Тема:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                <ui:ToggleSwitch
                                    IsChecked="{Binding DataContext.DarkTheme, RelativeSource={RelativeSource AncestorType=ui:FluentWindow}, Mode=TwoWay}"
                                    OffContent="Светлая"
                                    OnContent="Темная"/>
                                <ui:ToggleSwitch 
                                    IsChecked="{Binding ExportToExistingFile}"
                                    OffContent="Создать новый отчет"
                                    OnContent="Обновить общий отчет"
                                    Margin="0,0,20,0"/>
                                <ui:Button 
                                    Content="Начать экспорт" 
                                    Icon="{ui:SymbolIcon Symbol=Play24}"
                                    Command="{Binding DataContext.StartExportCommand, RelativeSource={RelativeSource AncestorType=TabControl}}"
                                    Appearance="Primary"/>                                
                            </StackPanel>
                        </Border>
                    </Grid>
                </DataTemplate>
            </TabControl.ContentTemplate>
        </TabControl>
    </Grid>
</ui:FluentWindow>